<html>
<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-dag@0.8.0"></script>
  <!-- <script src="data.js"></script> -->

  <style>
    html {
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
    }

    svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <svg></svg>
  <script>

    (async () => {
      // fetch data and render
      const resp = await fetch(
        "https://api.airtable.com/v0/appoOuybfOmmEd4rF/People", 
        {
          headers: {
            Authorization: "Bearer keythMZv756Dup760" 
          }
        }
      );

      const records = await resp.json();

      const data = records.records.map(record => 
        ({
          id: record.id,
          parentIds: record.fields.Parents ?? [],
          childrenIds: record.fields.Children ?? [],
          name: record.fields.Name,
          image: (record.fields.Photo ?? [ {"url": "https://via.placeholder.com/150"} ])[0].url,
          birthDate: record.fields["Birth Date"],
          gender: record.fields.Gender,
          languages: record.fields.Languages
        })
      );

      const dag = d3.dagStratify()(data);
      const nodeRadius = 80;
      const layout = d3
        .sugiyama() // base layout
        .decross(d3.decrossOpt()) // minimize number of crossings
        .nodeSize((node) => [(node ? 3.6 : 0.25) * nodeRadius, 3 * nodeRadius]); // set node size instead of constraining to fit
      const { width, height } = layout(dag);

      // --------------------------------
      // This code only handles rendering
      // --------------------------------

      function diagonal(s, d) {
        path = `
        M${s.x},${s.y}
        L${d.x},${s.y}
        L${d.x},${d.y}
        `
        return path
      }

      const svgSelection = d3.select("svg");
      svgSelection.attr("viewBox", [0, 0, width, height].join(" "));
      const defs = svgSelection.append("defs"); // For gradients

      const steps = dag.size();
      const interp = d3.interpolateRainbow;
      const colorMap = new Map();
      for (const [i, node] of dag.idescendants().entries()) {
        colorMap.set(node.data.id, interp(i / steps));
      }

      console.log(dag);

      // How to draw edges
      const line = d3
        .line()
        .curve(d3.curveCatmullRom)
        .x((d) => d.x)
        .y((d) => d.y);

      console.log(dag.links())
      // Plot edges
      svgSelection
        .append("g")
        .selectAll("path")
        .data(dag.links())
        .enter()
        .append("path")
        .attr("d", (d) => {     
          return diagonal(d.source, d.target)
        })
        .attr("fill", "none")
        .attr("stroke-width", 3)
        .attr("stroke", ({ source, target }) => {
          // encodeURIComponents for spaces, hope id doesn't have a `--` in it
          const gradId = encodeURIComponent(`${source.data.id}--${target.data.id}`);
          const grad = defs
            .append("linearGradient")
            .attr("id", gradId)
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", source.x)
            .attr("x2", target.x)
            .attr("y1", source.y)
            .attr("y2", target.y);
          grad
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", colorMap.get(source.data.id));
          grad
            .append("stop")
            .attr("offset", "100%")
            .attr("stop-color", colorMap.get(target.data.id));
          return `url(#${gradId})`;
        });

      // Plot node circles

      // Select nodes
      const nodes = svgSelection
        .append("g")
        .selectAll("g")
        .data(dag.descendants())
        .enter()
        .append("g")
        .attr("transform", ({ x, y }) => `translate(${x}, ${y})`);

      nodes
        .append("circle")
        .attr("r", nodeRadius)
        .attr("fill", (d) => {
          defs
            .append("pattern")
            .attr("id", d.data.id)
            .attr('height', '1')
            .attr('width', '1')
            .append("image")
            .attr("xlink:href", d.data.image)
            .attr("width", nodeRadius * 2)
            .attr("height", nodeRadius * 2)
            .attr("x", 0)
            .attr("y", 0);

          return `url(#${d.data.id})`
        })


      // Add text to nodes
      // nodes
        // .append("text")
        // .text((d) => d.data.name)
        // .attr("font-family", "sans-serif")
        // .attr("text-anchor", "middle")
        // .attr("alignment-baseline", "middle")
        // .attr("fill", "white");

      // nodes
      //   .append("image")
      //   .attr("xlink:href", function(d) { 
      //     return d.data.image; 
      //   })
      //   .attr("width", 50)
      //   .attr("height", 50);
    })();
  </script>
</body>
