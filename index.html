<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-v6-tip@1.0.6/build/d3-v6-tip.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bumbeishvili/d3-tip-for-v6@4/d3-tip.min.css">
  <script src="https://unpkg.com/d3-dag@0.7.0"></script>

  <style>
    html {
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
    }

    svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <svg></svg>
  <script>
    (async () => {
      // fetch data and render
      const resp = await fetch(
        "https://api.airtable.com/v0/appoOuybfOmmEd4rF/People?sort%5B0%5D%5Bfield%5D=Ordering&sort%5B0%5D%5Bdirection%5D=asc", 
        {
          headers: {
            Authorization: "Bearer keythMZv756Dup760" 
          }
        }
      );

      const records = await resp.json();

      const data = records.records.map(record => 
        ({
          id: record.id,
          parents: (record.fields.Parents ?? []).sort(),
          children: (record.fields.Children ?? []).sort(),
          name: record.fields.Name,
          image: 'Photo' in record.fields ? record.fields.Photo[0].url : null,
          birthDate: record.fields["Birth Date"],
          gender: record.fields.Gender,
          languages: record.fields.Languages
        })
      );

      function uniq(a) {
        let seen = new Set();
        return a.filter(item => {
          let k = item.id;
          return seen.has(k) ? false : seen.add(k);
        });
      }

      const allLinks = data.reduce((strat, record) => {
        if (record.parents.length > 0) {
          strat.push({
            id: record.parents.join(""),
            parentIds: record.parents,
            name: null,
            image: null,
            isUnion: true
          })
          strat.push({
            id: record.id,
            parentIds: [record.parents.join("")],
            name: record.name,
            image: record.image
          })
        } else {
          strat.push({ id: record.id, name: record.name, image: record.image })
        }
        return strat
      }, []);

      strat = uniq(allLinks)
      
      const dag = d3.dagStratify()(strat);
      const nodeRadius = 80;
      const layout = d3
        .sugiyama()
        .decross(d3.decrossOpt())
        .nodeSize((node) => [(node ? 3.6 : 0.25) * nodeRadius, 3 * nodeRadius]); // set node size instead of constraining to fit
      const { width, height } = layout(dag);

      // --------------------------------
      // This code only handles rendering
      // --------------------------------

      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .direction('s')
        .offset([10, 0])
        .html((_, d) => {
            if (d.data.isUnion) return;
            var content = `
              <span style='margin-left: 2.5px;'><b>` + d.data.name + `</b></span><br>
            `
            return content.replace(new RegExp("null", "g"), "?")
        });

      function linkPath(s, d) {
        path = `
        M${s.x},${s.y}
        L${d.x},${s.y}
        L${d.x},${d.y}
        `

        // const path = "M" + s.x + "," + s.y +
        // " C " + s.x + "," + (s.y + d.y) / 2 + " " +
        // d.x +"," + (s.y + d.y) / 2 + " " +
        // d.x + "," + d.y

        return path
      }

      function zoomed({ transform }) {
        paths.attr("transform", transform);
        d3.select(".nodes").attr("transform", transform);
      }

      const svgSelection = d3.select("svg");
      svgSelection
      .attr("viewBox", [0, 0, width, height]
      .join(" "))
      .call(d3.zoom().on("zoom", zoomed))
      .call(tip)
      const defs = svgSelection.append("defs");

      // Plot edges
      const paths = svgSelection
        .append("g")
        .selectAll("path")
        .data(dag.links())
        .enter()
        .append("path")
        .attr("d", (d) => {     
          return linkPath(d.source, d.target)
        })
        .attr("fill", "none")
        .attr("stroke-width", 4)
        .attr("stroke-linejoin", "round")
        .attr("stroke", "black");
      // Plot node circles

      // Select nodes
      const nodes = svgSelection
        .append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(dag.descendants())
        .enter()
        .append("g")
        .attr("transform", ({ x, y }) => `translate(${x}, ${y})`)

      nodes
        .append("circle")
        .attr("r", nodeRadius)
        .attr("stroke-width", (d) => d.data.isUnion ? 0 : 4)
        .attr("stroke", "black")
        .attr("fill", (d) => {
          defs
          .append("pattern")
            .attr("id", d.data.id)
            .attr('height', '1')
            .attr('width', '1')
          .append("image")
            .attr("xlink:href", d.data.isUnion ? "heart.png" : (d.data.image ?? "fallback.png"))
            .attr("width", nodeRadius * 2)
            .attr("height", nodeRadius * 2)
            .attr("x", 0)
            .attr("y", 0);

          return `url(#${d.data.id})`
        });

      // --------------------------------
      // Interactivity
      // --------------------------------
        nodes
          .on('mouseover', (event, d) => {
            if (!d.data.isUnion) {
              tip.show(event, d);
            }
          })
          .on('mouseout', tip.hide)
          .on('click', (_, d) => {
          });

    })();
  </script>
</body>
</html>